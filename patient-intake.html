<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Intake - NeuroOnco AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

    <style>
        .intake-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--spacing-2xl) var(--spacing-lg);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-3xl);
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--bg-elevated);
            z-index: -1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all var(--transition-base);
        }

        .step.active .step-circle {
            background: var(--gradient-primary);
            border-color: var(--primary-blue);
            color: white;
        }

        .step.completed .step-circle {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            text-align: center;
        }

        .step.active .step-label {
            color: var(--primary-blue);
            font-weight: 600;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }

        .upload-card {
            background: var(--bg-elevated);
            border: 2px dashed var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .upload-card:hover {
            border-color: var(--primary-blue);
            background: var(--bg-tertiary);
        }

        .upload-card.uploaded {
            border-color: var(--success);
            border-style: solid;
            background: hsla(142, 70%, 55%, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-2xl);
            padding-top: var(--spacing-xl);
            border-top: 1px solid var(--glass-border);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-container">
                <a href="index.html" class="nav-brand">üß† NeuroOnco AI</a>
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                    <li><a href="patient-intake.html" class="nav-link active">New Case</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="intake-container">
        <h1 class="text-center mb-lg">New Patient Intake</h1>
        <p class="text-center text-secondary mb-xl">Multimodal data collection for AI-driven treatment planning</p>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Patient Info</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">MRI Upload</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Genomic Data</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Clinical History</div>
            </div>
            <div class="step" data-step="5">
                <div class="step-circle">5</div>
                <div class="step-label">Review</div>
            </div>
        </div>

        <!-- Form Sections -->
        <div class="card-glass">
            <!-- Step 1: Patient Information -->
            <div class="form-section active" id="step1">
                <h2>Patient Information</h2>
                <p class="text-secondary mb-lg">Basic demographic and contact information</p>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Patient Name</label>
                        <input type="text" class="form-input" id="patientName" placeholder="John Doe" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" class="form-input" id="patientDOB" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <select class="form-select" id="patientGender">
                            <option>Male</option>
                            <option>Female</option>
                            <option>Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Medical Record Number</label>
                        <input type="text" class="form-input" id="patientMRN" placeholder="MRN-123456">
                    </div>
                </div>
            </div>

            <!-- Step 2: MRI Upload -->
            <div class="form-section" id="step2">
                <h2>MRI Imaging Data</h2>
                <p class="text-secondary mb-lg">Upload T1, T1ce, T2, and FLAIR sequences</p>

                <div class="upload-grid">
                    <div class="upload-card" id="uploadT1">
                        <div class="upload-icon">üìÅ</div>
                        <h4>T1 Sequence</h4>
                        <p class="text-secondary">Click to upload</p>
                        <input type="file" class="form-file" accept=".nii,.nii.gz,.dcm">
                    </div>

                    <div class="upload-card" id="uploadT1ce">
                        <div class="upload-icon">üìÅ</div>
                        <h4>T1ce Sequence</h4>
                        <p class="text-secondary">Click to upload</p>
                        <input type="file" class="form-file" accept=".nii,.nii.gz,.dcm">
                    </div>

                    <div class="upload-card" id="uploadT2">
                        <div class="upload-icon">üìÅ</div>
                        <h4>T2 Sequence</h4>
                        <p class="text-secondary">Click to upload</p>
                        <input type="file" class="form-file" accept=".nii,.nii.gz,.dcm">
                    </div>

                    <div class="upload-card" id="uploadFLAIR">
                        <div class="upload-icon">üìÅ</div>
                        <h4>FLAIR Sequence</h4>
                        <p class="text-secondary">Click to upload</p>
                        <input type="file" class="form-file" accept=".nii,.nii.gz,.dcm">
                    </div>
                </div>
            </div>

            <!-- Step 3: Genomic Data -->
            <div class="form-section" id="step3">
                <h2>Genomic & Molecular Data</h2>
                <p class="text-secondary mb-lg">Upload VCF files or enter biomarker status manually</p>

                <div class="form-group">
                    <label class="form-label">Upload VCF File (Optional)</label>
                    <div class="file-upload" id="vcfUpload">
                        <div class="upload-icon">üß¨</div>
                        <p>Drop VCF file here or click to browse</p>
                        <input type="file" class="form-file" accept=".vcf,.vcf.gz">
                    </div>
                </div>

                <div class="grid-2 mt-xl">
                    <div class="form-group">
                        <label class="form-label">IDH1 Status</label>
                        <select class="form-select" id="idh1Status">
                            <option>Unknown</option>
                            <option>Wild-type</option>
                            <option>Mutant</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">MGMT Promoter</label>
                        <select class="form-select" id="mgmtStatus">
                            <option>Unknown</option>
                            <option>Methylated</option>
                            <option>Unmethylated</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ATRX Status</label>
                        <select class="form-select" id="atrxStatus">
                            <option>Unknown</option>
                            <option>Wild-type</option>
                            <option>Mutant</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">1p/19q Codeletion</label>
                        <select class="form-select" id="codeletionStatus">
                            <option>Unknown</option>
                            <option>Present</option>
                            <option>Absent</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 4: Clinical History -->
            <div class="form-section" id="step4">
                <h2>Clinical History & Performance Status</h2>
                <p class="text-secondary mb-lg">Patient symptoms, comorbidities, and functional status</p>

                <div class="form-group">
                    <label class="form-label">Chief Complaint & Symptoms</label>
                    <textarea class="form-textarea" id="symptoms"
                        placeholder="Describe presenting symptoms..."></textarea>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">KPS Score</label>
                        <select class="form-select" id="kpsScore">
                            <option>100 - Normal, no complaints</option>
                            <option>90 - Minor symptoms</option>
                            <option>80 - Normal activity with effort</option>
                            <option>70 - Cares for self</option>
                            <option>60 - Requires occasional assistance</option>
                            <option>50 - Requires considerable assistance</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ECOG Performance Status</label>
                        <select class="form-select" id="ecogScore">
                            <option>0 - Fully active</option>
                            <option>1 - Restricted in strenuous activity</option>
                            <option>2 - Ambulatory, self-care</option>
                            <option>3 - Limited self-care</option>
                            <option>4 - Completely disabled</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Comorbidities</label>
                    <textarea class="form-textarea" id="comorbidities"
                        placeholder="List existing medical conditions..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Upload Pathology Report (PDF)</label>
                    <div class="file-upload" id="pathologyUpload">
                        <div class="upload-icon">üìÑ</div>
                        <p>Drop PDF file here or click to browse</p>
                        <input type="file" class="form-file" accept=".pdf">
                    </div>
                </div>
            </div>

            <!-- Step 5: Review -->
            <div class="form-section" id="step5">
                <h2>Review & Submit</h2>
                <p class="text-secondary mb-lg">Please review all information before submitting</p>

                <div id="reviewContent" class="card"
                    style="background: var(--bg-elevated); padding: var(--spacing-xl);">
                    <!-- Review content will be populated dynamically -->
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                    ‚Üê Previous
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                    Next ‚Üí
                </button>
                <button class="btn btn-success" id="submitBtn" onclick="submitPatient()" style="display: none;">
                    Submit & Analyze
                </button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 5;
        const uploadedFiles = {};

        function updateStepUI() {
            // Update step indicators
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });

            // Update form sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`step${currentStep}`).classList.add('active');

            // Update buttons
            document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('nextBtn').style.display = currentStep < totalSteps ? 'block' : 'none';
            document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'block' : 'none';

            // Populate review if on last step
            if (currentStep === totalSteps) {
                populateReview();
            }
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                currentStep++;
                updateStepUI();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
            }
        }

        function setupFileUpload(cardId, fileType) {
            const card = document.getElementById(cardId);
            const input = card.querySelector('.form-file');

            card.addEventListener('click', () => input.click());

            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    uploadedFiles[fileType] = file;
                    card.classList.add('uploaded');
                    card.querySelector('.upload-icon').textContent = '‚úì';
                    card.querySelector('p').textContent = file.name;
                }
            });
        }

        function populateReview() {
            const review = document.getElementById('reviewContent');
            review.innerHTML = `
        <h3>Patient Information</h3>
        <p><strong>Name:</strong> ${document.getElementById('patientName').value || 'Not provided'}</p>
        <p><strong>DOB:</strong> ${document.getElementById('patientDOB').value || 'Not provided'}</p>
        <p><strong>Gender:</strong> ${document.getElementById('patientGender').value}</p>
        <p><strong>MRN:</strong> ${document.getElementById('patientMRN').value || 'Not provided'}</p>
        
        <h3 class="mt-lg">Uploaded Files</h3>
        <p><strong>MRI Sequences:</strong> ${Object.keys(uploadedFiles).filter(k => k.includes('mri')).length} files</p>
        <p><strong>Genomic Data:</strong> ${uploadedFiles.vcf ? '1 file' : 'Manual entry'}</p>
        <p><strong>Pathology Report:</strong> ${uploadedFiles.pathology ? '1 file' : 'Not uploaded'}</p>
        
        <h3 class="mt-lg">Biomarker Status</h3>
        <p><strong>IDH1:</strong> ${document.getElementById('idh1Status').value}</p>
        <p><strong>MGMT:</strong> ${document.getElementById('mgmtStatus').value}</p>
        <p><strong>ATRX:</strong> ${document.getElementById('atrxStatus').value}</p>
        <p><strong>1p/19q:</strong> ${document.getElementById('codeletionStatus').value}</p>
        
        <h3 class="mt-lg">Performance Status</h3>
        <p><strong>KPS:</strong> ${document.getElementById('kpsScore').value}</p>
        <p><strong>ECOG:</strong> ${document.getElementById('ecogScore').value}</p>
      `;
        }

        async function submitPatient() {
            const patient = {
                id: DataUtils.generateId(),
                name: document.getElementById('patientName').value,
                dob: document.getElementById('patientDOB').value,
                gender: document.getElementById('patientGender').value,
                mrn: document.getElementById('patientMRN').value,
                dateAdded: new Date(),
                status: 'In Progress',
                biomarkers: {
                    idh1: document.getElementById('idh1Status').value,
                    mgmt: document.getElementById('mgmtStatus').value,
                    atrx: document.getElementById('atrxStatus').value,
                    codeletion: document.getElementById('codeletionStatus').value
                },
                performance: {
                    kps: document.getElementById('kpsScore').value,
                    ecog: document.getElementById('ecogScore').value
                },
                files: uploadedFiles
            };

            // Show loading
            UI.showToast('Processing patient data...', 'info');

            // Simulate processing
            await DataUtils.simulateProcessing(2000);

            // Save patient
            AppState.addPatient(patient);
            AppState.setCurrentPatient(patient.id);

            // Create audit record
            await BlockchainUtils.saveAuditRecord(
                BlockchainUtils.createAuditRecord(patient.id, 'PATIENT_CREATED', patient)
            );

            UI.showToast('Patient added successfully!', 'success');

            // Redirect to MRI analysis
            setTimeout(() => {
                window.location.href = 'mri-analysis.html';
            }, 1500);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupFileUpload('uploadT1', 'mri_t1');
            setupFileUpload('uploadT1ce', 'mri_t1ce');
            setupFileUpload('uploadT2', 'mri_t2');
            setupFileUpload('uploadFLAIR', 'mri_flair');

            FileUpload.setupDropZone(document.getElementById('vcfUpload'), (files) => {
                if (files.length > 0) {
                    uploadedFiles.vcf = files[0];
                    UI.showToast('VCF file uploaded', 'success');
                }
            });

            FileUpload.setupDropZone(document.getElementById('pathologyUpload'), (files) => {
                if (files.length > 0) {
                    uploadedFiles.pathology = files[0];
                    UI.showToast('Pathology report uploaded', 'success');
                }
            });

            updateStepUI();
        });
    </script>
</body>

</html>