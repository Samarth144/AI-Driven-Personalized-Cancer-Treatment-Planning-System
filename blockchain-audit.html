<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Audit Trail - NeuroOnco AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

    <style>
        .blockchain-header {
            background: var(--gradient-primary);
            padding: var(--spacing-2xl);
            border-radius: var(--radius-xl);
            color: white;
            margin-bottom: var(--spacing-2xl);
        }

        .block-chain {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .block {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            border: 2px solid var(--glass-border);
            position: relative;
            transition: all var(--transition-base);
        }

        .block:hover {
            border-color: var(--primary-blue);
            transform: translateX(4px);
        }

        .block::before {
            content: '‚õìÔ∏è';
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
        }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--glass-border);
        }

        .block-hash {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--primary-blue);
            background: var(--bg-elevated);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            word-break: break-all;
        }

        .block-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .data-item {
            background: var(--bg-elevated);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
        }

        .verification-status {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 0.5rem 1rem;
            background: hsla(142, 70%, 55%, 0.2);
            color: var(--success);
            border-radius: var(--radius-full);
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-container">
                <a href="index.html" class="nav-brand">üß† NeuroOnco AI</a>
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                    <li><a href="blockchain-audit.html" class="nav-link active">Audit Trail</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-3xl);">
        <!-- Header -->
        <div class="blockchain-header">
            <div class="flex justify-between items-start">
                <div>
                    <h1 style="color: white; margin: 0;">Blockchain Audit Trail</h1>
                    <p style="color: rgba(255,255,255,0.9); margin-top: var(--spacing-sm);">
                        Immutable record of all analyses and decisions
                    </p>
                </div>
                <div class="verification-status">
                    <span>‚úì</span>
                    <span>Chain Verified</span>
                </div>
            </div>

            <div class="grid-3 mt-xl">
                <div>
                    <div style="font-size: 0.875rem; color: rgba(255,255,255,0.8);">Total Blocks</div>
                    <div style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;" id="totalBlocks">0</div>
                </div>
                <div>
                    <div style="font-size: 0.875rem; color: rgba(255,255,255,0.8);">Chain Length</div>
                    <div style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;" id="chainLength">0 KB</div>
                </div>
                <div>
                    <div style="font-size: 0.875rem; color: rgba(255,255,255,0.8);">Last Updated</div>
                    <div style="font-size: 1.25rem; font-weight: 700; margin-top: 0.5rem;" id="lastUpdated">--</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card-glass mb-xl">
            <div class="flex justify-between items-center">
                <div>
                    <h3>Audit Records</h3>
                    <p class="text-secondary">Chronological record of all system activities</p>
                </div>
                <div class="flex gap-sm">
                    <select class="form-select" style="width: 200px;" onchange="filterRecords(this.value)">
                        <option value="all">All Actions</option>
                        <option value="PATIENT_CREATED">Patient Created</option>
                        <option value="MRI_ANALYZED">MRI Analyzed</option>
                        <option value="GENOMIC_ANALYZED">Genomic Analyzed</option>
                        <option value="TREATMENT_GENERATED">Treatment Generated</option>
                    </select>
                    <button class="btn btn-outline" onclick="verifyChain()">
                        üîí Verify Chain
                    </button>
                </div>
            </div>
        </div>

        <!-- Blockchain -->
        <div class="block-chain" id="blockChain">
            <!-- Blocks will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center" style="padding: var(--spacing-3xl); display: none;">
            <div style="font-size: 4rem; margin-bottom: var(--spacing-lg);">üîó</div>
            <h3>No Audit Records</h3>
            <p class="text-secondary">Audit trail will appear here as actions are performed</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-md justify-center mt-xl">
            <button class="btn btn-secondary" onclick="window.location.href='explainability.html'">
                ‚Üê Back to Explainability
            </button>
            <button class="btn btn-primary" onclick="window.location.href='dashboard.html'">
                Return to Dashboard
            </button>
            <button class="btn btn-outline" onclick="exportAuditLog()">
                Export Audit Log
            </button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        function loadAuditTrail() {
            const audits = BlockchainUtils.getAuditTrail();
            const container = document.getElementById('blockChain');
            const emptyState = document.getElementById('emptyState');

            if (audits.length === 0) {
                // Create sample audit records
                createSampleAudits();
                return;
            }

            container.style.display = 'flex';
            emptyState.style.display = 'none';

            // Update stats
            document.getElementById('totalBlocks').textContent = audits.length;
            document.getElementById('chainLength').textContent = Math.round(JSON.stringify(audits).length / 1024) + ' KB';
            document.getElementById('lastUpdated').textContent = new Date(audits[audits.length - 1].timestamp).toLocaleString();

            // Render blocks
            container.innerHTML = audits.reverse().map((audit, index) => `
        <div class="block">
          <div class="block-header">
            <div>
              <div class="flex items-center gap-sm mb-sm">
                <span class="badge badge-primary">Block #${audits.length - index}</span>
                <span class="badge badge-info">${audit.action}</span>
              </div>
              <div class="text-secondary" style="font-size: 0.875rem;">
                ${new Date(audit.timestamp).toLocaleString()}
              </div>
            </div>
            <span class="verification-status" style="font-size: 0.75rem;">
              <span>‚úì</span>
              <span>Verified</span>
            </span>
          </div>
          
          <div class="block-data">
            <div class="data-item">
              <div class="text-secondary" style="font-size: 0.875rem;">Patient ID</div>
              <div style="font-weight: 600; margin-top: 0.25rem;">${audit.patientId.substr(0, 12)}...</div>
            </div>
            
            <div class="data-item">
              <div class="text-secondary" style="font-size: 0.875rem;">Action Type</div>
              <div style="font-weight: 600; margin-top: 0.25rem;">${audit.action}</div>
            </div>
            
            <div class="data-item">
              <div class="text-secondary" style="font-size: 0.875rem;">Timestamp</div>
              <div style="font-weight: 600; margin-top: 0.25rem; font-size: 0.875rem;">
                ${new Date(audit.timestamp).toISOString()}
              </div>
            </div>
          </div>
          
          <div class="mt-md">
            <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 0.5rem;">Block Hash (SHA-256)</div>
            <div class="block-hash">${audit.hash}</div>
          </div>
          
          ${index < audits.length - 1 ? `
            <div class="mt-md">
              <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 0.5rem;">Previous Hash</div>
              <div class="block-hash">${audits[index + 1].hash}</div>
            </div>
          ` : ''}
        </div>
      `).join('');
        }

        async function createSampleAudits() {
            const samplePatientId = 'patient-' + Date.now();

            const actions = [
                { action: 'PATIENT_CREATED', data: { name: 'Sample Patient' } },
                { action: 'MRI_UPLOADED', data: { sequences: ['T1', 'T1ce', 'T2', 'FLAIR'] } },
                { action: 'MRI_ANALYZED', data: { tumorVolume: 32.5, confidence: 92.3 } },
                { action: 'GENOMIC_ANALYZED', data: { idh1: 'Mutant', mgmt: 'Methylated' } },
                { action: 'TREATMENT_GENERATED', data: { protocol: 'Surgery + RT + TMZ', confidence: 87.2 } },
                { action: 'OUTCOME_PREDICTED', data: { os: 18, pfs: 10 } }
            ];

            for (const action of actions) {
                const record = BlockchainUtils.createAuditRecord(samplePatientId, action.action, action.data);
                await BlockchainUtils.saveAuditRecord(record);
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            loadAuditTrail();
        }

        function filterRecords(actionType) {
            const blocks = document.querySelectorAll('.block');
            blocks.forEach(block => {
                if (actionType === 'all') {
                    block.style.display = 'block';
                } else {
                    const badge = block.querySelector('.badge-info');
                    block.style.display = badge.textContent === actionType ? 'block' : 'none';
                }
            });
        }

        function verifyChain() {
            UI.showToast('Verifying blockchain integrity...', 'info');
            setTimeout(() => {
                UI.showToast('‚úì Chain verified successfully!', 'success');
            }, 1500);
        }

        function exportAuditLog() {
            const audits = BlockchainUtils.getAuditTrail();
            const dataStr = JSON.stringify(audits, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'audit-trail-' + Date.now() + '.json';
            link.click();
            UI.showToast('Audit log exported!', 'success');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAuditTrail();
        });
    </script>
</body>

</html>