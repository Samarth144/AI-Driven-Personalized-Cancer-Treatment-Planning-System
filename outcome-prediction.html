<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outcome Prediction - NeuroOnco AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        .survival-curves {
            background: var(--bg-secondary);
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-xl);
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .prediction-card {
            background: var(--gradient-primary);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            text-align: center;
        }

        .prediction-value {
            font-size: 3rem;
            font-weight: 700;
            margin: var(--spacing-md) 0;
        }

        .prediction-range {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .side-effects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .side-effect-card {
            background: var(--bg-elevated);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--warning);
        }

        .risk-meter {
            height: 8px;
            background: var(--bg-primary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--spacing-sm);
        }

        .risk-fill {
            height: 100%;
            background: var(--gradient-warm);
            transition: width var(--transition-slow);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-container">
                <a href="index.html" class="nav-brand">üß† NeuroOnco AI</a>
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                    <li><a href="outcome-prediction.html" class="nav-link active">Outcome Prediction</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-3xl);">
        <div class="flex justify-between items-center mb-xl">
            <div>
                <h1>Outcome & Toxicity Prediction</h1>
                <p class="text-secondary">AI-powered survival forecasting and side-effect modeling</p>
            </div>
            <button class="btn btn-primary" onclick="generatePredictions()">
                üìà Generate Predictions
            </button>
        </div>

        <!-- Key Predictions -->
        <div class="prediction-grid">
            <div class="prediction-card">
                <h3 style="color: white; margin: 0;">Overall Survival</h3>
                <div class="prediction-value" id="osMedian">--</div>
                <div class="prediction-range" id="osRange">Median months</div>
            </div>

            <div class="prediction-card" style="background: var(--gradient-accent);">
                <h3 style="color: white; margin: 0;">Progression-Free Survival</h3>
                <div class="prediction-value" id="pfsMedian">--</div>
                <div class="prediction-range" id="pfsRange">Median months</div>
            </div>

            <div class="prediction-card" style="background: var(--gradient-warm);">
                <h3 style="color: white; margin: 0;">Quality of Life</h3>
                <div class="prediction-value" id="qolScore">--</div>
                <div class="prediction-range">Predicted score (0-100)</div>
            </div>
        </div>

        <!-- Survival Curves -->
        <div class="survival-curves">
            <h3 class="mb-lg">Survival Probability Curves</h3>
            <div style="height: 400px;">
                <canvas id="survivalChart"></canvas>
            </div>
        </div>

        <!-- Side Effects Prediction -->
        <div class="card-glass mb-xl">
            <h3>Predicted Side Effects & Toxicity</h3>
            <p class="text-secondary mb-lg">Probability of experiencing treatment-related adverse events</p>

            <div class="side-effects-grid" id="sideEffectsGrid">
                <!-- Side effects will be populated here -->
            </div>
        </div>

        <!-- Risk Stratification -->
        <div class="grid-2 mb-xl">
            <div class="card-glass">
                <h3>Risk Stratification</h3>
                <div style="height: 300px;">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>

            <div class="card-glass">
                <h3>Prognostic Factors</h3>
                <div style="height: 300px;">
                    <canvas id="factorsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Timeline Visualization -->
        <div class="card-glass mb-xl">
            <h3>Predicted Treatment Timeline & Outcomes</h3>
            <p class="text-secondary mb-lg">Expected progression over time</p>

            <div style="height: 300px;">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-md justify-center">
            <button class="btn btn-secondary" onclick="window.location.href='treatment-plan.html'">
                ‚Üê Back to Treatment Plan
            </button>
            <button class="btn btn-primary" onclick="window.location.href='pathway-simulator.html'">
                Simulate Treatment Pathway ‚Üí
            </button>
            <button class="btn btn-outline" onclick="downloadReport()">
                Download Report
            </button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let outcomeData = null;

        async function generatePredictions() {
            UI.showToast('Generating outcome predictions...', 'info');

            await DataUtils.simulateProcessing(2500);

            outcomeData = DataUtils.generateMockAnalysis('outcome');

            // Update key metrics
            document.getElementById('osMedian').textContent = outcomeData.overallSurvival.median;
            document.getElementById('osRange').textContent = `Range: ${outcomeData.overallSurvival.range[0]}-${outcomeData.overallSurvival.range[1]} months`;

            document.getElementById('pfsMedian').textContent = outcomeData.progressionFreeSurvival.median;
            document.getElementById('pfsRange').textContent = `Range: ${outcomeData.progressionFreeSurvival.range[0]}-${outcomeData.progressionFreeSurvival.range[1]} months`;

            document.getElementById('qolScore').textContent = outcomeData.qualityOfLife;

            // Populate side effects
            populateSideEffects();

            // Create charts
            createSurvivalChart();
            createRiskChart();
            createFactorsChart();
            createTimelineChart();

            UI.showToast('Predictions generated successfully!', 'success');

            if (AppState.currentPatient) {
                AppState.updateAnalysis(AppState.currentPatient.id, 'outcome', outcomeData);
            }
        }

        function populateSideEffects() {
            const grid = document.getElementById('sideEffectsGrid');
            const effects = [
                { name: 'Fatigue', risk: outcomeData.sideEffects.fatigue, color: 'var(--warning)' },
                { name: 'Nausea', risk: outcomeData.sideEffects.nausea, color: 'var(--warning)' },
                { name: 'Cognitive Impairment', risk: outcomeData.sideEffects.cognitiveImpairment, color: 'var(--error)' },
                { name: 'Hematologic Toxicity', risk: outcomeData.sideEffects.hematologicToxicity, color: 'var(--error)' }
            ];

            grid.innerHTML = effects.map(effect => `
        <div class="side-effect-card">
          <div class="flex justify-between items-center mb-sm">
            <strong>${effect.name}</strong>
            <span class="badge badge-warning">${effect.risk}%</span>
          </div>
          <div class="risk-meter">
            <div class="risk-fill" style="width: ${effect.risk}%;"></div>
          </div>
        </div>
      `).join('');
        }

        function createSurvivalChart() {
            const ctx = document.getElementById('survivalChart').getContext('2d');

            // Generate survival curve data
            const months = Array.from({ length: 61 }, (_, i) => i);
            const osData = months.map(m => 100 * Math.exp(-0.03 * m));
            const pfsData = months.map(m => 100 * Math.exp(-0.05 * m));

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Overall Survival',
                            data: osData,
                            borderColor: 'hsl(210, 100%, 56%)',
                            backgroundColor: 'hsla(210, 100%, 56%, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Progression-Free Survival',
                            data: pfsData,
                            borderColor: 'hsl(180, 65%, 55%)',
                            backgroundColor: 'hsla(180, 65%, 55%, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Months', color: 'hsl(0, 0%, 75%)' },
                            ticks: { color: 'hsl(0, 0%, 75%)' },
                            grid: { color: 'hsla(0, 0%, 100%, 0.05)' }
                        },
                        y: {
                            title: { display: true, text: 'Survival Probability (%)', color: 'hsl(0, 0%, 75%)' },
                            ticks: { color: 'hsl(0, 0%, 75%)' },
                            grid: { color: 'hsla(0, 0%, 100%, 0.05)' },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'hsl(0, 0%, 75%)' } }
                    }
                }
            });
        }

        function createRiskChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Low Risk', 'Moderate Risk', 'High Risk'],
                    datasets: [{
                        data: [25, 45, 30],
                        backgroundColor: [
                            'hsla(142, 70%, 55%, 0.8)',
                            'hsla(45, 95%, 60%, 0.8)',
                            'hsla(0, 75%, 60%, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'hsl(0, 0%, 75%)' }
                        }
                    }
                }
            });
        }

        function createFactorsChart() {
            const ctx = document.getElementById('factorsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Age', 'KPS', 'Tumor Size', 'MGMT', 'IDH1', 'Location'],
                    datasets: [{
                        label: 'Impact on Prognosis',
                        data: [65, 85, 75, 90, 80, 70],
                        backgroundColor: 'hsla(270, 70%, 60%, 0.8)',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: 'hsl(0, 0%, 75%)' },
                            grid: { color: 'hsla(0, 0%, 100%, 0.05)' }
                        },
                        y: {
                            ticks: { color: 'hsl(0, 0%, 75%)' },
                            grid: { color: 'hsla(0, 0%, 100%, 0.05)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'hsl(0, 0%, 75%)' } }
                    }
                }
            });
        }

        function createTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Baseline', '3 mo', '6 mo', '12 mo', '18 mo', '24 mo'],
                    datasets: [
                        {
                            label: 'Tumor Volume',
                            data: [100, 40, 35, 45, 50, 55],
                            borderColor: 'hsl(0, 75%, 60%)',
                            backgroundColor: 'hsla(0, 75%, 60%, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Quality of Life',
                            data: [75, 65, 70, 68, 65, 63],
                            borderColor: 'hsl(142, 70%, 55%)',
                            backgroundColor: 'hsla(142, 70%, 55%, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: 'hsl(0, 0%, 75%)' },
                            grid: { color: 'hsla(0, 0%, 100%, 0.05)' }
                        },
                        y: {
                            ticks: { color: 'hsl(0, 0%, 75%)' },
                            grid: { color: 'hsla(0, 0%, 100%, 0.05)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'hsl(0, 0%, 75%)' } }
                    }
                }
            });
        }

        function downloadReport() {
            UI.showToast('Generating PDF report...', 'info');
            setTimeout(() => {
                UI.showToast('Report downloaded!', 'success');
            }, 1500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(generatePredictions, 500);
        });
    </script>
</body>

</html>